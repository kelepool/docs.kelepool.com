import{_ as o,r as i,o as p,c,a as n,b as e,d as s,e as t}from"./app.aa16d652.js";const l={},r=n("h1",{id:"how-to-use-hardware-wallet-to-integrate-kelepool",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#how-to-use-hardware-wallet-to-integrate-kelepool","aria-hidden":"true"},"#"),s(" How to use hardware wallet to integrate kelepool?")],-1),u=n("p",null,"First of all, Hardware wallet needs to help users to judge, or let users choose the following two staking methods. If Hardware wallet decides to let users choose the staking method, it needs to provide two staking entries (large amount and small amount) and inform the user of the difference.",-1),d=n("p",null,"If Hardware wallet wants to automatically help users choose the staking method, it can also judge whether the staking amount is greater than 32 when the user stakings.",-1),k=n("ul",null,[n("li",null,"Large amount staking: The user manages the withdrawal certificate by himself, the minimum support is 32ETH, the maximum support is 3200ETH, and the staking amount must be an integer multiple of 32."),n("li",null,"Small amount staking: Coke platform multi-signature management withdrawal certificate, the minimum support is 0.01ETH, and the maximum support is 100000000000ETH.")],-1),m=s("Mainnet contract\uFF1A"),h={href:"https://etherscan.io/address/0xACBA4cFE7F30E64dA787c6Dc7Dc34f623570e758#code",target:"_blank",rel:"noopener noreferrer"},v=s("0xACBA4cFE7F30E64dA787c6Dc7Dc34f623570e758"),b=s("Goerli contract\uFF1A"),g={href:"https://goerli.etherscan.io/address/0xdCAe38cC28606e61B1e54D8b4b134588e4ca7Ab7#code",target:"_blank",rel:"noopener noreferrer"},f=s("0xdCAe38cC28606e61B1e54D8b4b134588e4ca7Ab7"),w=n("h2",{id:"stake-\u2265-32-eth",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#stake-\u2265-32-eth","aria-hidden":"true"},"#"),s(" Stake \u2265 32 ETH")],-1),y=n("h3",{id:"step-1-transfer-eth1-address-to-eth2-withdrawal-certificate",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#step-1-transfer-eth1-address-to-eth2-withdrawal-certificate","aria-hidden":"true"},"#"),s(" Step 1: Transfer ETH1 address to ETH2 withdrawal certificate")],-1),_=s("Hardware wallet needs to use the officially provided "),q={href:"https://github.com/ethereum/consensus-specs/pull/2149",target:"_blank",rel:"noopener noreferrer"},T=s("ETH1_ADDRESS_WITHDRAWAL_PREFIX"),E=s(" method to convert the user's ETH1 deposit address into an ETH2 withdrawal certificate. The specific conversion method is as follows:"),x=t(`<ul><li>ETH2 withdrawal voucher = <code>0x01 + 11 00 + ETH1 address with 0x removed</code></li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Example:
ETH1 deposit address: 0x5dD3BD08cBc8498C8640Abc26D19480219bB0606
ETH2 withdrawal certificate: 0x0100000000000000000000005dd3bd08cbc8498c8640abc26d19480219bb0606
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="step-2-request-the-kele-pool-api" tabindex="-1"><a class="header-anchor" href="#step-2-request-the-kele-pool-api" aria-hidden="true">#</a> Step 2: Request the Kele Pool API</h3><h4 id="_1-user-address-registration" tabindex="-1"><a class="header-anchor" href="#_1-user-address-registration" aria-hidden="true">#</a> (1) User address registration</h4>`,4),H={id:"user-v2-anonymouslogin",tabindex:"-1"},A=n("a",{class:"header-anchor",href:"#user-v2-anonymouslogin","aria-hidden":"true"},"#",-1),C=s(),P={href:"https://test-api.kelepool.com/user/v2/anonymouslogin",target:"_blank",rel:"noopener noreferrer"},S=s("/user/v2/anonymouslogin"),B=t(`<p>This interface only needs to be called when the user stakings for the first time. Of course, you can also call it every time the user stakings. Note that this interface must be called before the user stakings.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>POST https://test-api.kelepool.com/user/v2/anonymouslogin

<span class="token punctuation">{</span>
    // User staking wallet address
    <span class="token string">&quot;payee_addr&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;0xA49F98416aa4B158c2e752FD8031Fb295D330B22&quot;</span>, 
    // the staked token <span class="token punctuation">(</span>eth<span class="token punctuation">)</span>
    <span class="token string">&quot;token&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;eth&quot;</span>,
    // The data <span class="token builtin class-name">source</span> is convenient <span class="token keyword">for</span> business cooperation statistics <span class="token punctuation">(</span>eg: Hardware wallet<span class="token punctuation">)</span>
    <span class="token string">&quot;source&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Hardware wallet&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-parameters-required-to-generate-large-amount-staking-of-contracts" tabindex="-1"><a class="header-anchor" href="#_2-parameters-required-to-generate-large-amount-staking-of-contracts" aria-hidden="true">#</a> \uFF082\uFF09Parameters required to generate large-amount staking of contracts</h4>`,3),D={id:"eth2-v2-validator-keypair",tabindex:"-1"},V=n("a",{class:"header-anchor",href:"#eth2-v2-validator-keypair","aria-hidden":"true"},"#",-1),F=s(),I={href:"https://test-api.kelepool.com/eth2/v2/validator/keypair",target:"_blank",rel:"noopener noreferrer"},j=s("/eth2/v2/validator/keypair"),L=t(`<p>This interface is used to generate parameters for large-amount staking of the contract, and the converted ETH withdrawal certificate needs to be passed in. Since the large-amount staking is that the user controls the withdrawal key, but the verification node needs the Kele Pool to operate, it is necessary to call this interface to generate some parameters required by the operation node. When the user stakings, the verification node parameters must be submitted to the ETH2.0 official deposit contract.</p><p>There is a <code>count</code> in the requested parameter here, which is calculated by the user&#39;s staking amount. There are calculation examples below. Here, <code>2</code> is passed in, so two pieces of verification node information are returned. You may find that their <code>withdrawal certificate</code> is the same. In the future, users can withdraw the staking amount and income of all nodes through a withdrawal certificate. Since users may pass in 35, 100, and 89, which are not multiples of 32, when staking, Hardware wallet needs to calculate the effective number of stakings, and only allows users to staking multiples of 32.</p><ul><li>Number of validating nodes = <code>(The amount of ETH staked by users - (the amount of ETH staked by users % 32)) / 32</code></li><li>Effective staking amount = <code>(user staked ETH amount - (user staked ETH amount % 32))</code></li><li>Large staking fee = <code>0.05 * number of validators</code></li></ul><p>Suppose the user staked 68ETH:</p><ul><li>Number of validators = (68 - 68 % 32) / 32 = 2</li><li>Number of valid stakings = (68 - 68 % 32) = 64</li><li>Large staking fee = 0.05 * 2 = 0.1ETH</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>POST https://test-api.kelepool.com/eth2/v2/validator/keypair

Request parameters:
<span class="token punctuation">{</span>
    // The converted ETH2 withdrawal certificate above <span class="token punctuation">(</span>remove 0x<span class="token punctuation">)</span>
    <span class="token string">&quot;deposit_credentials&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;0100000000000000000000005dd3bd08cbc8498c8640abc26d19480219bb0606&quot;</span>,
    // Number of validating nodes, calculation method <span class="token operator">=</span> <span class="token punctuation">(</span>number of ETH staked by <span class="token function">users</span> - <span class="token punctuation">(</span>number of ETH staked by <span class="token function">users</span> % <span class="token number">32</span><span class="token punctuation">))</span> / <span class="token number">32</span>
    <span class="token string">&quot;count&quot;</span>:2,
    // Whether to regenerate a new keystore. <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">=</span>no, <span class="token assign-left variable">1</span><span class="token operator">=</span>yes<span class="token punctuation">)</span>
    <span class="token string">&quot;recreate&quot;</span>:0
<span class="token punctuation">}</span>

\`\`\`json

Response Result:
<span class="token punctuation">{</span>
    // an integer number, equal to <span class="token number">0</span> <span class="token keyword">for</span> success, greater than <span class="token number">0</span> <span class="token keyword">for</span> failure
    <span class="token string">&quot;code&quot;</span>:0,
    // the message to <span class="token builtin class-name">return</span> after failure
    <span class="token string">&quot;message&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;success&quot;</span>,
    <span class="token string">&quot;data&quot;</span>:<span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            // validator public key
            <span class="token string">&quot;pubkey&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;86ee4eecf1c83725020cf8667c555b286b54445691da44aa7a671b6d18abf118452e60876216f9adec5e64ff09c3e231&quot;</span>,
            // Withdrawal Credentials
            <span class="token string">&quot;withdrawal_credentials&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;0100000000000000000000005dd3bd08cbc8498c8640abc26d19480219bb0606&quot;</span>,
            // Validator signature
            <span class="token string">&quot;signature&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;a61e5ed96b5b22ec9da92cf3f09c24cf9230ec1db99918e9dedfc9440de473f64b7520b5fb40558d0bc9f009dd20731917c3dbf6b3cfd98b48377a190d9e2959df3d2fa2dcec9c09e8be420accc9daa25301d4a2ce1636a5413ac066e7a4628f&quot;</span>,
            //  Merkle tree root
            <span class="token string">&quot;deposit_data_root&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;ebb84a75e241501cc64c4e42dd3cdb7a2f72e6af60ab828b2fb246905eb629e5&quot;</span>,
            // ETH network name
            <span class="token string">&quot;network_name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Goerli&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
            <span class="token string">&quot;pubkey&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;83909737754d15dd3ad1281a3f0e62baa64d3c0abb3ed218c3baf7ff250058a24fe1143a5243c3b015e3f93ed6af1e18&quot;</span>,
            <span class="token string">&quot;withdrawal_credentials&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;0100000000000000000000005dd3bd08cbc8498c8640abc26d19480219bb0606&quot;</span>,
            <span class="token string">&quot;signature&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;b95af475d67e8438e49cfaad12dacd789c705938fd6a8fee93a1a170ef6322c2cf37c643d1d010b23734c04e9028b58d034435dd6c9f19610090bfdefb7522c69e99b0a7830f6d967f1d07e3ff30128c8b516d40232e5595ac91d746420da993&quot;</span>,
            <span class="token string">&quot;deposit_data_root&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;f08ca526395300d60ccc6db28d931ba129944f44d4bb92c773424e120dde222b&quot;</span>,
            <span class="token string">&quot;network_name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Goerli&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="step-3-call-contract-staking" tabindex="-1"><a class="header-anchor" href="#step-3-call-contract-staking" aria-hidden="true">#</a> Step 3: Call contract staking</h3><p>After getting the validator&#39;s public key data returned above, we can call the contract to staking a large amount. The number of verification nodes calculated according to the staking amount above is <code>2</code>, so the API interface returns two pieces of verification node data. We need to combine these two data when calling the contract, and then pass it into the contract. For details, please refer to the js code below.</p><ul><li>The user stakings 64ETH and gets <code>64 / 32 = 2</code>, then the user needs to prepare an additional fee of <code>0.05 * 2 = 0.1ETH</code></li><li>Therefore, the amount transferred by the user to the contract becomes <code>64.1ETH</code>, and contracts below or above this amount will be rejected</li><li>Kele Pool charges a fee for each verification node. The validity period of the operating fee is when ETH2.0 goes online. After that, Kele Pool will charge according to the situation.</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>

<span class="token comment">// import libraries</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ethers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;ethers&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// connect metamask</span>
<span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>providers<span class="token punctuation">.</span>Web3Provider</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>ethereum<span class="token punctuation">)</span>
<span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;eth_requestAccounts&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> signer <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">getSigner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> userAddress <span class="token operator">=</span> <span class="token keyword">await</span> signer<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// initialize</span>
<span class="token keyword">const</span> kelepool <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token string">&quot;0xACBA4cFE7F30E64dA787c6Dc7Dc34f623570e758&quot;</span><span class="token punctuation">,</span><span class="token comment">// // The proxy contract of kelepool</span>
  <span class="token literal-property property">abi</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string-property property">&quot;anonymous&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token operator">...</span><span class="token punctuation">.</span>\u3000<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token comment">// Contract ABI</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> contract <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span>kelepool<span class="token punctuation">.</span>address<span class="token punctuation">,</span> kelepool<span class="token punctuation">.</span>abi<span class="token punctuation">,</span> signer<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// Assemble large staking data</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// The data object returned by the API</span>
<span class="token keyword">let</span> stakingPublicKey <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
<span class="token keyword">let</span> stakingSignature <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
<span class="token keyword">let</span> stakingCredentials <span class="token operator">=</span> <span class="token string">&#39;001ae74d19004b360d02d411795cee1451dc20679f13a13aafce7de2448b60cb&#39;</span> <span class="token comment">// user withdrawal credentials</span>
<span class="token keyword">let</span> stakingRoot <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> validator <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    stakingPublicKey <span class="token operator">+=</span> validator<span class="token punctuation">.</span>pubkey <span class="token comment">// Concatenate the public key string</span>
    stakingSignature <span class="token operator">+=</span> validator<span class="token punctuation">.</span>signature <span class="token comment">// Concatenate the signature string</span>
    stakingRoot<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;0x&#39;</span> <span class="token operator">+</span> validator<span class="token punctuation">.</span>deposit_data_root<span class="token punctuation">)</span> <span class="token comment">// Concatenate the deposit_data_root string</span>
<span class="token punctuation">}</span>

<span class="token comment">// convert data</span>
<span class="token keyword">let</span> prefix <span class="token operator">=</span> <span class="token string">&#39;0x&#39;</span>
<span class="token keyword">let</span> pubkey <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">arrayify</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> stakingPublicKey<span class="token punctuation">)</span>
<span class="token keyword">let</span> withdrawal_credentials <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">arrayify</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> stakingCredentials<span class="token punctuation">)</span>
<span class="token keyword">let</span> signature <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">arrayify</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> stakingSignature<span class="token punctuation">)</span>
<span class="token keyword">let</span> deposit_data_root <span class="token operator">=</span> stakingRoot

<span class="token comment">// execure large staking, at least 32ETH,we staking 64ETH here, it needs 0.05ETH fee for every validator,so we have to add more 0.ETH for kelepool fee.</span>
<span class="token keyword">let</span> amount <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseUnits</span><span class="token punctuation">(</span><span class="token string">&#39;64.1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;ether&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// The following is the V1 version (deprecated), and the source channel parameter cannot be passed.</span>
<span class="token comment">// The source channel parameter is the identifier assigned to the third-party channel by Coke Mining Pool, which is used to distinguish which channel received the staked amount during dividend statistics.</span>
<span class="token comment">// To use the V1 version, you must request before the user stakings: the user address registration interface (/user/v2/anonymouslogin) establishes the association between the user address and the source channel, so that we can distinguish the channel staking amount.</span>
<span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> contract<span class="token punctuation">.</span><span class="token function">createValidator</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> pubkey<span class="token punctuation">,</span> withdrawal_credentials<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> deposit_data_root<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">from</span><span class="token operator">:</span> userAddress<span class="token punctuation">,</span> <span class="token comment">// user wallet address</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> amount<span class="token punctuation">,</span><span class="token comment">// staking amount</span>
    <span class="token literal-property property">gasLimit</span><span class="token operator">:</span> <span class="token number">10000000</span> <span class="token comment">// max gas limit</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// The following is the V2 version (recommended), which can pass source channel parameters.</span>
<span class="token comment">// The source channel parameter is the identifier assigned to the third-party channel by Coke Mining Pool, which is used to distinguish which channel received the staked amount during dividend statistics.</span>
<span class="token comment">// It doesn&#39;t matter if you have connected to the V1 version before. After updating to the V2 version, the user&#39;s staking will be written to the source passed from the contract first.</span>
<span class="token keyword">let</span> source <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">arrayify</span><span class="token punctuation">(</span>ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">formatBytes32String</span><span class="token punctuation">(</span><span class="token string">&quot;ThirdParty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> contract<span class="token punctuation">.</span><span class="token function">createValidatorV2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> pubkey<span class="token punctuation">,</span> withdrawal_credentials<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> deposit_data_root<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">from</span><span class="token operator">:</span> userAddress<span class="token punctuation">,</span> <span class="token comment">// user wallet address</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> amount<span class="token punctuation">,</span><span class="token comment">// staking amount</span>
    <span class="token literal-property property">gasLimit</span><span class="token operator">:</span> <span class="token number">10000000</span> <span class="token comment">// max gas limit</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">transaction id: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>tx<span class="token punctuation">.</span>hash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="stake-32-eth" tabindex="-1"><a class="header-anchor" href="#stake-32-eth" aria-hidden="true">#</a> Stake \uFF1C 32 ETH</h2><h4 id="_1-user-address-registration-1" tabindex="-1"><a class="header-anchor" href="#_1-user-address-registration-1" aria-hidden="true">#</a> (1) User address registration</h4>`,12),N={id:"user-v2-anonymouslogin-1",tabindex:"-1"},R=n("a",{class:"header-anchor",href:"#user-v2-anonymouslogin-1","aria-hidden":"true"},"#",-1),W=s(),K={href:"https://test-api.kelepool.com/user/v2/anonymouslogin",target:"_blank",rel:"noopener noreferrer"},M=s("/user/v2/anonymouslogin"),U=t(`<p>This interface only needs to be called when the user stakings for the first time. Of course, you can also call it every time the user stakings. Note that this interface must be called before the user stakings.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>POST https://test-api.kelepool.com/user/v2/anonymouslogin

<span class="token punctuation">{</span>
    // User staking wallet address
    <span class="token string">&quot;payee_addr&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;0xA49F98416aa4B158c2e752FD8031Fb295D330B22&quot;</span>, 
    // the staked token <span class="token punctuation">(</span>eth<span class="token punctuation">)</span>
    <span class="token string">&quot;token&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;eth&quot;</span>,
    // The data <span class="token builtin class-name">source</span> is convenient <span class="token keyword">for</span> business cooperation statistics <span class="token punctuation">(</span>eg: Hardware wallet<span class="token punctuation">)</span>
    <span class="token string">&quot;source&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Hardware wallet&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="step-2-call-contract-staking" tabindex="-1"><a class="header-anchor" href="#step-2-call-contract-staking" aria-hidden="true">#</a> Step 2: Call contract staking</h3><p>Small stakes are as simple as depositing tokens into the Cola Pool smart contract. Users can staking a minimum of 0.01ETH and a maximum amount of ETH. When the total amount of small stakings in the contract exceeds 32ETH, the Cola Pool will use the [Ethereum official CLI tool](https://github.com/ethereum /staking-deposit-cli) generates withdrawal credentials in the cold wallet and automatically creates a verification node. The user&#39;s funds are managed and secured by the cola mining pool. After the official launch of ETH2.0 in the future, the cola mining pool will open the withdrawal interface for users.</p><ul><li>Suppose we intend to staking <code>125.0172ETH</code>, after the staking, Cola Pool will immediately create \`3 validators&#39; (32ETH each)</li><li>The remaining <code>29.0172ETH</code> will be staked in the contract, and a verification node will be created after other users staking enough <code>32ETH</code></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>
<span class="token comment">// import libraries</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ethers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;ethers&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// connect metamask</span>
<span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>providers<span class="token punctuation">.</span>Web3Provider</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>ethereum<span class="token punctuation">)</span>
<span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;eth_requestAccounts&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> signer <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">getSigner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> userAddress <span class="token operator">=</span> <span class="token keyword">await</span> signer<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// initialize</span>
<span class="token keyword">const</span> kelepool <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token string">&quot;0xACBA4cFE7F30E64dA787c6Dc7Dc34f623570e758&quot;</span><span class="token punctuation">,</span><span class="token comment">// The proxy contract of kelepool</span>
  <span class="token literal-property property">abi</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string-property property">&quot;anonymous&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token operator">...</span><span class="token punctuation">.</span>\u3000<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token comment">// contract abi</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> contract <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span>kelepool<span class="token punctuation">.</span>address<span class="token punctuation">,</span> kelepool<span class="token punctuation">.</span>abi<span class="token punctuation">,</span> signer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// execute small staking, at least 0.01ETH, we staking 125.0172ETH</span>
<span class="token keyword">let</span> amount <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseUnits</span><span class="token punctuation">(</span><span class="token string">&quot;125.0172&quot;</span><span class="token punctuation">,</span> <span class="token string">&#39;ether&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// The following is the V1 version (deprecated), and the source channel parameter cannot be passed.</span>
<span class="token comment">// The source channel parameter is the identifier assigned to the third-party channel by Coke Mining Pool, which is used to distinguish which channel received the staked amount during dividend statistics.</span>
<span class="token comment">// To use the V1 version, you must request before the user stakings: the user address registration interface (/user/v2/anonymouslogin) establishes the association between the user address and the source channel, so that we can distinguish the channel staking amount.</span>
<span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> contract<span class="token punctuation">.</span><span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">from</span><span class="token operator">:</span> userAddress<span class="token punctuation">,</span> <span class="token comment">// user wallet address</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> amount<span class="token punctuation">,</span><span class="token comment">// staking amount</span>
    <span class="token literal-property property">gasLimit</span><span class="token operator">:</span> <span class="token number">10000000</span> <span class="token comment">// max gas limit</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The following is the V2 version (recommended), which can pass source channel parameters.</span>
<span class="token comment">// The source channel parameter is the identifier assigned to the third-party channel by Coke Mining Pool, which is used to distinguish which channel received the staked amount during dividend statistics.</span>
<span class="token comment">// It doesn&#39;t matter if you have connected to the V1 version before. After updating to the V2 version, the user&#39;s staking will be written to the source passed from the contract first.</span>
<span class="token keyword">let</span> source <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">arrayify</span><span class="token punctuation">(</span>ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">formatBytes32String</span><span class="token punctuation">(</span><span class="token string">&quot;ThirdParty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> contract<span class="token punctuation">.</span><span class="token function">depositV2</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token literal-property property">from</span><span class="token operator">:</span> userAddress<span class="token punctuation">,</span> <span class="token comment">// user wallet address</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> amount<span class="token punctuation">,</span><span class="token comment">// staking amount</span>
    <span class="token literal-property property">gasLimit</span><span class="token operator">:</span> <span class="token number">10000000</span> <span class="token comment">// max gas limit</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">transition hash: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>tx<span class="token punctuation">.</span>hash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="set-partner-fee-and-payment-address" tabindex="-1"><a class="header-anchor" href="#set-partner-fee-and-payment-address" aria-hidden="true">#</a> Set partner fee and payment address</h2><ol><li>Partners can contact Coke Mining Pool to set up large pledge procedures, channel marks, payment address, fee type, etc. After the pledge is completed, the contract will automatically transfer the handling fee to the payment address set by the partner. Kele Pool currently charges 0.05ETH as a handling fee for 32ETH staking.</li></ol><ul><li><p>If the source when the user pledges matches the partner channel flag set by the partner, the contract will require the user to pay the partner fee</p></li><li><p>Partners can query their own handling fee information through the contract&#39;s getPartnerInfo</p></li><li><p>The partner does not set the handling fee or the handling fee is set to 0. By default, each node charges 0.05 handling fee</p></li></ul><ol start="2"><li>There are two ways to collect the handling fee (take the user as a pledge of 10 verification nodes at a time, and the partner sets a handling fee of 0.1ETH as an example)</li></ol><ul><li><p>Charged according to the number of nodes: the contract will charge 1.5ETH as a handling fee, of which 0.5ETH will be given to the Coke mining pool, and 1ETH will be automatically transferred to the partner</p></li><li><p>Charged per pledge: the contract will charge 0.6ETH as a handling fee, of which 0.5ETH will be given to the Coke mining pool, and 0.1ETH will be automatically transferred to the partner</p></li></ul>`,11);function O(G,z){const a=i("ExternalLinkIcon");return p(),c("div",null,[r,u,d,k,n("p",null,[m,n("a",h,[v,e(a)])]),n("p",null,[b,n("a",g,[f,e(a)])]),w,y,n("p",null,[_,n("a",q,[T,e(a)]),E]),x,n("h5",H,[A,C,n("a",P,[S,e(a)])]),B,n("h5",D,[V,F,n("a",I,[j,e(a)])]),L,n("h5",N,[R,W,n("a",K,[M,e(a)])]),U])}var X=o(l,[["render",O],["__file","Hardware.html.vue"]]);export{X as default};
